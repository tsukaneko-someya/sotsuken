<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script
    src="https://cdn.jsdelivr.net/gh/aframevr/aframe@bd6bf821eda2522f84a1dc2b6d78674dfcd06e4a/dist/aframe-master.min.js"></script>

  <title>色覚多様性に配慮した調理体験のためのVR教材開発</title>
</head>

<body>
  <a-scene vr-mode-ui="enabled: false">
    <!-- position:左右 上下 手前奥 -->
    <!-- 背景 -->
    <a-sky color="#C0E5F0"></a-sky>
    <!-- フライパン -->
    <a-gltf-model src="3Dmodel/frying_pan.glb" position="-0.18 0.69 -0.19" rotation="0 90 0"></a-gltf-model>
    <!-- 調理台 -->
    <a-gltf-model class="kitchen" src="3Dmodel/kitchen_s.glb" position="0 0.05 -1" rotation="0 90 0"></a-gltf-model>
    <a-gltf-model class="kitchen" src="3Dmodel/kitchen_s.glb" position="-2 0.05 -1" rotation="0 90 0"></a-gltf-model>
    <a-gltf-model class="kitchen" src="3Dmodel/kitchen_s.glb" position="-4 0.05 -1" rotation="0 90 0"></a-gltf-model>
    <a-gltf-model class="kitchen" src="3Dmodel/kitchen_s.glb" position="0 0.05 -4" rotation="0 90 0"></a-gltf-model>
    <a-gltf-model class="kitchen" src="3Dmodel/kitchen_s.glb" position="-2 0.05 -4" rotation="0 90 0"></a-gltf-model>
    <a-gltf-model class="kitchen" src="3Dmodel/kitchen_s.glb" position="-4 0.05 -4" rotation="0 90 0"></a-gltf-model>
    <a-gltf-model class="kitchen" src="3Dmodel/kitchen_s.glb" position="0 0.05 -7" rotation="0 90 0"></a-gltf-model>
    <a-gltf-model class="kitchen" src="3Dmodel/kitchen_s.glb" position="-2 0.05 -7" rotation="0 90 0"></a-gltf-model>
    <a-gltf-model class="kitchen" src="3Dmodel/kitchen_s.glb" position="-2 0.05 -9.5" rotation="0 0 0"></a-gltf-model>
    <a-gltf-model class="kitchen" src="3Dmodel/kitchen_s.glb" position="-4 0.05 -7" rotation="0 90 0"></a-gltf-model>
    <!-- 教室 -->
    <a-gltf-model class="classroom" src="3Dmodel/classroom.glb" position="0 0 -2" rotation="0 90 0"></a-gltf-model>
    <!-- 肉 -->
    <a-gltf-model id="niku_0" src="yakiniku/yakiniku_00_c.glb" position="0.05 0 -4.04" rotation="0 90 0">
    </a-gltf-model>
    <a-gltf-model id="niku_1" src="yakiniku/yakiniku_01_c.glb" position="0.05 0 -4.04" rotation="0 90 0">
    </a-gltf-model>
    <a-gltf-model id="niku_2" src="yakiniku/yakiniku_02_c.glb" position="0.05 0. -4.04" rotation="0 90 0">
    </a-gltf-model>
    <!-- はし -->
    <a-gltf-model src="3Dmodel/simple_chopsticks.glb" scale="0.1 0.1 0.1" position="0.1 0.63 -0.7" rotation="0 110 0">
    </a-gltf-model>

    <!-- 画像を3枚用意して切り替える -->
    <a-image id="introImage" src="1.jpeg" position="0 1.5 -3" width="2.3" height="1.6"></a-image>
    <a-image id="introSousa" src="sousa_0.png" position="0 0.7 -3" width="2.3" height="0.5"></a-image>


    <!-- ctrl+Alt+iでテストモード -->

    <!-- カメラ -->
    <a-entity position="0 0 0" rotation="0 0 0">
      <a-camera position="0 0 3">
        <!-- ボタン -->
        <!-- 焼肉用 -->
        <a-image src="button/yaku_1.jpeg" btn="hover: button/yaku_2.jpeg; clearedHover: button/yaku_1.jpeg;" btn
          class="collidable" data-type="yaku_btn" position="0.1 -0.3 -1.5" height="0.15" width="0.3">
        </a-image>
        <a-image src="button/reset_1.png" btn="hover: button/reset_2.png; clearedHover: button/reset_1.png;" btn
          class="collidable" data-type="reset_btn" position="0.5 -0.3 -1.5" height="0.15" width="0.3">
        </a-image>
        <!-- 色変更 -->
        <a-image src="button/1pan_1.jpeg"
          btn="hover: button/1pan_2.jpeg; clearedHover: button/1pan_1.jpeg; sky: #C0E5F0; room: 3Dmodel/classroom.glb; kitchen: 3Dmodel/kitchen_s.glb; niku_0: yakiniku_00_c.glb; niku_1: yakiniku_01_c.glb; niku_2: yakiniku_02_c.glb"
          class="collidable" data-type="color_btn" position="0 0 -1.5" height="0.2" width="0.2"></a-image>
        <a-image src="button/1gata_1.jpeg"
          btn="hover: button/1gata_2.jpeg; clearedHover: button/1gata_1.jpeg; sky: #DDE2F1; room: 3Dmodel/classroom_1.glb; kitchen: 3Dmodel/kitchen_s1.glb; niku_0: yakiniku_00_p.glb; niku_1: yakiniku_01_p.glb; niku_2: yakiniku_02_p.glb"
          class="collidable" data-type="color_btn" position="0.2 0 -1.5" height="0.2" width="0.2"></a-image>
        <a-image src="button/2gata_1.jpeg"
          btn="hover: button/2gata_2.jpeg; clearedHover: button/2gata_1.jpeg; sky: #D6DCF0; room: 3Dmodel/classroom_2.glb; kitchen: 3Dmodel/kitchen_s2.glb; niku_0: yakiniku_00_d.glb; niku_1: yakiniku_01_d.glb; niku_2: yakiniku_02_d.glb"
          class="collidable" data-type="color_btn" position="0.4 0 -1.5" height="0.2" width="0.2"></a-image>
        <a-image src="button/3gata_1.jpeg"
          btn="hover: button/3gata_2.jpeg; clearedHover: button/3gata_1.jpeg; sky: #B2E9E8; room: 3Dmodel/classroom_3.glb; kitchen: 3Dmodel/kitchen_s3.glb; niku_0: yakiniku_00_t.glb; niku_1: yakiniku_01_t.glb; niku_2: yakiniku_02_t.glb"
          class="collidable" data-type="color_btn" position="0.6 0 -1.5" height="0.2" width="0.2"></a-image>
        <!-- <a-cursor></a-cursor> -->
        <!-- お手本表示 -->
        <a-image src="sample.png" id="sample" position="-0.8 -0.1 -1.5" height="0.6" width="0.9"></a-image>

        <a-entity id="ctlR" laser-controls="hand: right"
          raycaster="far: 20; interval: 1000; lineColor: red; objects: .collidable" position="0 1 0"></a-entity>
        <a-entity id="ctlL" laser-controls="hand: left" raycaster="showLine: false;"></a-entity>
        <a-entity cursor="rayOrigin: mouse"></a-entity>
      </a-camera>
    </a-entity>
  </a-scene>

  <script>
    // 変数
    const aGltfModel = document.querySelectorAll('a-gltf-model');
    const collidable = document.querySelectorAll('.collidable');
    const sample = document.getElementById('sample');
    let ctlR = document.querySelector('#ctlR');
    let ctlL = document.querySelector('#ctlL');
    let meshes0 = [];
    let meshes1 = [];
    let meshes2 = [];
    const nikuImg = document.getElementById('introImage');
    let running = false;
    const roomColor = document.querySelector('.classroom');
    const kitchenColor = document.querySelectorAll('.kitchen');
    let imageNumber = 0;
    const introImage = document.getElementById('introImage');
    const imageList = ["1.jpeg", "2.jpeg", "3.jpeg", "6.jpeg", "4.jpeg", "5.jpeg", "sousa_1.png", "sousa_2.png", "sousa_3.png", "sousa_4.png"];
    const introSousa = document.getElementById('introSousa');
    let fadingOut = true;
    let opacity_0 = 1.0;
    let opacity_1 = 1.0;
    let opacity_2 = 0.0;
    let vol = 0;
    let uiVisible = true;
    let sampleVisible = false;

    // 表示する文字
    // const textList = ["色覚多様性について\n色の見え方は人によって異なります。\nまずは実際に、どのように見えるのか見てみましょう。",
    //   "このように、\n同じ肉でも人によって見え方が違います。",
    //   "それでは、実際に体験してもらいましょう！\n体験が終わったら、ぜひ感想を教えてください。"];


    // 調理室の表示
    aGltfModel.forEach(m => {
      m.setAttribute('visible', 'false');
    });
    collidable.forEach(m => {
      m.setAttribute('visible', 'false');
    });
    sample.setAttribute('visible', 'false');

    // 説明パート
    ctlR.addEventListener('triggerup', () => {
      if (imageNumber < imageList.length) {
        imageNumber++;
        introImage.setAttribute('src', imageList[imageNumber]);
      }
      if (imageNumber == 6) {
        aGltfModel.forEach(m => {
          m.setAttribute('visible', 'true');
          introSousa.setAttribute('visible', 'false');
        });
      } else if (imageNumber >= imageList.length) {
        collidable.forEach(m => {
          m.setAttribute('visible', 'true');
        })
        introImage.setAttribute('visible', 'false');

        // 右gripを押すとUI非表示
        ctlR.addEventListener('gripup', () => {
          uiVisible = !uiVisible;
          collidable.forEach(m => {
            m.setAttribute('visible', uiVisible);
          });
        });
        // 左gripを押すとお手本表示
        ctlL.addEventListener('gripup', () => {
          sampleVisible = !sampleVisible;
          sample.setAttribute('visible', sampleVisible);
          console.log(sampleVisible)
        });
      }
    });
    ctlL.addEventListener('triggerup', () => {
      if (imageNumber > 0) {
        imageNumber--;
        introImage.setAttribute('src', imageList[imageNumber]);
      }
    });


    // 肉の初期設定
    niku_0.addEventListener('model-loaded', (e) => {
      const model = e.detail.model; // three.js の Object3D
      model.traverse((node) => {
        if (node.isMesh) {
          node.material.transparent = true;
          node.material.opacity = opacity_0;
          // 半透明にするために必要
          // 透明度を設定
          meshes0.push(node)
          node.renderOrder = 2;
          // console.log(meshes0);
        }
      });
    });
    niku_1.addEventListener('model-loaded', (e) => {
      const model = e.detail.model; // three.js の Object3D
      model.traverse((node) => {
        if (node.isMesh) {
          node.material.transparent = true;  // 半透明にするために必要
          node.material.opacity = opacity_1;   // 透明度を設定
          meshes1.push(node)
          node.renderOrder = 1;
          // console.log(meshes1);
        }
      });
    });
    niku_2.addEventListener('model-loaded', (e) => {
      const model = e.detail.model; // three.js の Object3D
      model.traverse((node) => {
        if (node.isMesh) {
          node.material.transparent = true;  // 半透明にするために必要
          node.material.opacity = opacity_2;   // 透明度を設定
          meshes2.push(node)
          node.renderOrder = 3;
          // console.log(meshes2);
        }
      });
    });

    // クリックイベント
    AFRAME.registerComponent("btn", {
      schema: {
        hover: { type: "string" },
        clearedHover: { type: "string" },
        sky: { type: "string" },
        room: { type: "string" },
        kitchen: { type: "string" },
        niku_0: { type: "string" },
        niku_1: { type: "string" },
        niku_2: { type: "string" }
      },

      init: function () {
        const el = this.el;
        let running = false;
        const yakuBtn = document.querySelector(".yaku_btn");
        const sky = document.querySelector("a-sky");
        const room = document.querySelector(".classroom");
        const kitchens = document.querySelectorAll(".kitchen");
        const niku_0 = document.getElementById("niku_0");
        const niku_1 = document.getElementById("niku_1");
        const niku_2 = document.getElementById("niku_2");
        let isHovering = false;

        ctlR.addEventListener("raycaster-intersection", (e) => {
          if (e.detail.els.includes(el)) {
            isHovering = true; //対象のボタンがレイにあたっているか
            el.setAttribute("src", this.data.hover);
            console.log(e.detail.els)
          }
        });

        ctlR.addEventListener("raycaster-intersection-cleared", (e) => {
          if (e.detail.clearedEls.includes(el)) {
            isHovering = false; //対象のボタンからレイが外れているか
            el.setAttribute("src", this.data.clearedHover);
          }
        });

        // type取得
        const type = el.dataset.type;
        if (type === "yaku_btn") {  // 焼くボタンが押された時の処理
          ctlR.addEventListener("triggerup", (e) => {
            if (!uiVisible) return; // 表示されないときは処理しない
            if (isHovering) {
              running = !running;
            }
          });

          const bgm = new Audio('pan_fry_steak3.mp3');

          // 焼きループ（常に実行、runningがtrueの時だけ処理）
          setInterval(() => {
            bgm.volume = vol;
            // console.log(vol);
            if (!running) {
              if (vol <= 0.1) {
                vol = 0;
                bgm.pause();
              } else {
                vol -= 0.05;
              }
              return;
            }
            // 音を鳴らす
            // 音源：https://taira-komori.net/cooking01.html

            if (vol >= 0.9) {
              vol = 1;
            } else {
              vol += 0.05;
            }
            bgm.play();
            bgm.loop = true;

            if (fadingOut) {
              // mesh0 をフェードアウト
              let allZero = true;
              meshes0.forEach(mesh0 => {
                mesh0.material.opacity -= 0.05;
                if (mesh0.material.opacity < 0) mesh0.material.opacity = 0;
                if (mesh0.material.opacity > 0) allZero = false;
                opacity_0 = mesh0.material.opacity;
                // console.log(opacity_0)
              });

              // 全部0になったら次へ
              if (allZero) fadingOut = false;

            } else {
              // mesh2 をフェードイン
              meshes2.forEach(mesh2 => {
                mesh2.material.opacity += 0.05;
                if (mesh2.material.opacity > 1) mesh2.material.opacity = 1;
                opacity_2 = mesh2.material.opacity;
              });
            }
          }, 100);
        } else if (type === "reset_btn") {
          ctlR.addEventListener("triggerup", (e) => {
            if (!uiVisible) return;  // 表示されないときは処理しない
            if (!isHovering) return; // レイが当たっていない場合は処理しない
            meshes0.forEach(mesh0 => {
              mesh0.material.opacity = 1.0;
            });
            opacity_0 = 1.0;

            meshes2.forEach(mesh2 => {
              mesh2.material.opacity = 0.0;
            });
            opacity_2 = 0.0;

            fadingOut = true;
            vol = 0;
          });
        } else {  // 他のボタンが押されたときの処理
          ctlR.addEventListener("triggerup", () => {
            if (!uiVisible) return; // 表示されないときは処理しない
            if (!isHovering) return;
            sky.setAttribute("color", this.data.sky);
            room.setAttribute("src", this.data.room);
            kitchens.forEach(k => k.setAttribute("src", this.data.kitchen));
            niku_0.setAttribute("src", "yakiniku/" + this.data.niku_0);
            niku_1.setAttribute("src", "yakiniku/" + this.data.niku_1);
            niku_2.setAttribute("src", "yakiniku/" + this.data.niku_2);
          });
        }
      }
    });




  </script>
</body>


</html>